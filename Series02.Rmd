---
title: "Statistical tests - Assignment\n"
author: "Alexis LAGARDE"
date: "`r format(Sys.time(), '%d %B, %Y, %H:%M')`"
output:
  html_document:
    df_print: paged
    code_folding: hide
    toc: false
    number_sections: true
---

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
# Load necessary libraries
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggplot2)
library(corrplot)
library(knitr)
```

# Statistical tests: comparison of medians (or means?)
In this series of exercises, you will explore how to compare two groups of data, using non-parametric tests (or parametric tests… if it makes sense to do so).

## Make clear what is a statistical test, and when to use it.
Below are some questions to guide your analysis. You can answer them in your notebook, with a short sentence for each question.
  
  - What is a median? A mean?  
The median is the middle value of an ordered dataset, while the mean is the arithmetic average of all values.  
(Freedman, Pisani & Purves, *Statistics*, 4th ed., 2007)  

  - What is a variance? A standard deviation?  
The variance is the average of the squared deviations from the mean, and the standard deviation is the square root of the variance, expressed in the same units as the data.  
(Freedman, Pisani & Purves, *Statistics*, 4th ed., 2007)  

  - What is a normal distribution?  
A normal distribution is a symmetric, bell-shaped probability distribution defined by its mean and standard deviation.  
(Montgomery & Runger, *Applied Statistics and Probability for Engineers*, 7th ed., 2018)  

  - What is a statistical test?  
A statistical test is a procedure that uses sample data to decide whether to reject a null hypothesis about a population.  
(Montgomery & Runger, *Applied Statistics and Probability for Engineers*, 7th ed., 2018)  

  - When to use a statistical test?  
A statistical test is used when comparing groups, assessing relationships, or checking whether observed results could be due to chance.  
(Altman, *Practical Statistics for Medical Research*, 1st ed., 1990)  

  - What is a parametric test? A non-parametric test?  
A parametric test assumes that data follow a known distribution, usually normal, whereas a non-parametric test makes fewer assumptions and can be applied to ordinal or non-normally distributed data.  
(Field, *Discovering Statistics Using SPSS*, 5th ed., 2018)  

  - What are the assumptions of parametric tests?  
Parametric tests assume normality, homogeneity of variances, independence of observations, and data measured on an interval or ratio scale.  
(Field, *Discovering Statistics Using SPSS*, 5th ed., 2018)  

  - What are the assumptions of non-parametric tests?  
Non-parametric tests generally assume only independence of observations, without requiring normality or equal variances.    
(Conover, *Practical Nonparametric Statistics*, 3rd ed., 1999)  

  - What is a p-value?  
A p-value is the probability of obtaining results at least as extreme as those observed if the null hypothesis is true.  
(Casella & Berger, *Statistical Inference*, 2nd ed., 2002)  

  - What is the risk of error when using a statistical test?  
The risk of error arises from Type I error (α), rejecting a true null hypothesis, and Type II error (β), failing to reject a false null hypothesis.  
(Casella & Berger, *Statistical Inference*, 2nd ed., 2002)  

  
  - What is the difference between a paired and an unpaired test?  
A paired test compares two related samples, such as before-and-after measurements on the same subjects, while an unpaired test compares two independent groups.  
(Altman, *Practical Statistics for Medical Research*, 1st ed., 1990)

## Effect of treatment over time
This is a very classical question in clinical or sport research: does a treatment-training have an effect over time?

To answer this question scientifically, measurements must be taken before and after treatment, and possibly later, in order to assess whether the effect is lasting or not.

### The data

Download the file ```PrePost.csv```

```{r}
data <- read.csv("data/test_data/PrePost.csv")
```

This file contains before/after measurements. The treatment is a rehabilitation training for individuals with cardiac conditions.

Before going further, you have to make clear what are the measured variables. What do they measure? What are the units? What are the possible values? What are the expected changes over rehabilitation.

Make a table, with one row per variable, and the following columns:


<table border="1" align="center">
  <tr>
    <th align="center" valign="middle">Variable</th>
    <th align="center" valign="middle">Description</th>
    <th align="center" valign="middle">Unit</th>
    <th align="center" valign="middle">Possible values</th>
    <th align="center" valign="middle">Expected change after rehabilitation</th>
  </tr>
  <tr>
    <td align="center" valign="middle">Perf</td>
    <td align="center" valign="middle">Heart rate in beats per minute  measured during exercise test.</td>
    <td align="center" valign="middle">BPM</td>
    <td align="center" valign="middle">125–148 bpm (range in the dataset)</td>
    <td align="center" valign="middle">Expected toincrease, since patients are able to reach higher exercise heart rates after rehabilitation.</td>
  </tr>
  <tr>
    <td align="center" valign="middle">Time</td>
    <td align="center" valign="middle">Measurement moment, indicating whether the heart rate was recorded before or after the rehabilitation program.</td>
    <td align="center" valign="middle">Categorical (`Before`, `After`)</td>
    <td align="center" valign="middle">Only two values: Before, After </td>
    <td align="center" valign="middle">No change expected since `Time` is used as grouping variable for comparison.</td>
  </tr>
</table>

### The analysis

You want to know if the treatment has an effect on one or more of the measured variables.

  - Does the treatment have an effect?  
**Before**: 125, 130, 132, 135, 136, 138, 140, 145  
**After**: 127, 132, 133, 136, 139, 141, 145, 148  

We can observe that the heart rates generally increase after rehabilitation, suggesting that the treatment does have an effect.  


  - What comparison are you going to make?  
We are comparing the heart rate before and after rehabilitation for the same patients.  
This is a paired comparison (dependent samples).  
The comparison is: perf Before vs. After for each patient.

    - Which test will you use? Parametric or non-parametric?  
Because the sample size is small and the assumption of normality may not be satisfied, a non-parametric test (Mann–Whitney U) is more appropriate than a parametric test.

    - Which graph illustrates the effect of the treatment?  
To illustrate the effect of the treatment, a box plot can be used to show the distribution of heart rates before and after rehabilitation.  

```{r}
# Create a box plot to illustrate the effect of the treatment
ggplot(data, aes(x = time, y = perf, fill = time)) +
  geom_boxplot() +
  labs(title = "Heart Rate Before and After Rehabilitation",
       x = "Time",
       y = "Heart Rate (BPM)") +
  theme_minimal()
```  
    
  - What sentence will you write in your thesis to explain your result?  
Patient showed a significant increase in heart rate after rehabilitation, indicating that the treatment was effective in improving cardiovascular performance.

## Testing some stereotypes
Humans have stereotypes, some of them are probably true, some others are probably false (e.g., ref ).

Here, we will test stereotypes about snorers… among others.

### The data
Download the file `snore.txt`
```{r}
data_snore <- read.table("data/test_data/snore.txt", header = TRUE)
```

This file contains anthropometric and qualitative measurements (1 person per line).

### The analysis 

  - Do the data confirm the following stereotypes? Provide a reasoned answer (data, figure, result sentence) for each question.

    - Are snorers fatter?
```{r message=FALSE, warning=FALSE}
# Box plot of weight by snoring status
ggplot(data_snore, aes(x = snore, y = weight, fill = snore)) +
  geom_boxplot() +
  labs(title = "Weight Distribution by Snoring Status",
       x = "Snoring Status",
       y = "Weight (kg)") +
  theme_minimal()
# Summary statistics
data_snore %>%
  group_by(snore) %>%
  summarise(mean_weight = mean(weight, na.rm = TRUE),
            median_weight = median(weight, na.rm = TRUE),
            sd_weight = sd(weight, na.rm = TRUE))
```
Yes, the data suggest that snorers tend to have a higher weight compared to non-snorers. The box plot shows that the median weight of snorers is higher, and the summary statistics confirm this observation.
- Do snorers drink or smoke more?
```{r}
# Bar plot of drinking status by snoring status
ggplot(data_snore, aes(x = factor(alcool), fill = factor(snore))) +
  geom_bar(position = "dodge") +
  labs(
    title = "Number of people per alcohol consumption and snoring status",
    x = "Amout of alcohol drinked",
    y = "Number of people",
    fill = "Snorers"
  ) +
  theme_minimal()

# Bar plot of smoking status by snoring status
ggplot(data_snore, aes(x = snore, fill = tabac)) +
  geom_bar(position = "dodge") +
  labs(title = "Smoking Status by Snoring Status",
       x = "Snoring Status",
       y = "Proportion") +
  theme_minimal()
```

On the alcohol graph, snorers are spread across higher alcohol categories, but non-snorers still make up the majority of the `0` group. The difference exists but isn’t huge.
On the smoking graph, the gap is a way clearer, a higher proportion of snorers are smokers compared to non-snorers.

Snorers are more strongly associated with smoking than with drinking. The smoking difference between snorers and non-snorers is more pronounced than the drinking difference.

  - Are men fatter?
  
```{r message=FALSE, warning=FALSE}
data_snore$sex <- ifelse(data_snore$sex == "H", "Male", "Female")

ggplot(data_snore, aes(x = sex, y = weight, fill = sex)) +
  geom_boxplot(alpha = 0.7) +
  labs(title = "Weight distribution by sex",
       x = "Sex",
       y = "Weight (kg)") +
  theme_minimal()


data_snore %>%
  group_by(sex) %>%
  summarise(
    count = n(),
    mean = mean(weight, na.rm = TRUE),
    sd = sd(weight, na.rm = TRUE),
    min = min(weight, na.rm = TRUE),
    Q1 = quantile(weight, 0.25, na.rm = TRUE),
    median = median(weight, na.rm = TRUE),
    Q3 = quantile(weight, 0.75, na.rm = TRUE),
    max = max(weight, na.rm = TRUE)
  )


```
The boxplot indicates that men are not fatter than women in this dataset, as women have a slightly higher median weight (~97 kg vs ~94 kg for men), while men simply show a greater variability in their weight distribution.

  - Do women smoke less?
  
```{r}
# Load data
data_snore <- read.table("data/test_data/snore.txt", header = TRUE)

# Recode sex and tabac, and force factor levels
data_snore <- data_snore %>%
  mutate(
    sex = factor(ifelse(sex == "H", "Male", "Female"), levels = c("Male", "Female")),
    smoker = ifelse(tabac == "O", "Smoker", "Non-smoker")
  )

# Calculate percentage of smokers by sex
smoking_percent <- data_snore %>%
  group_by(sex) %>%
  summarise(percent_smoker = mean(smoker == "Smoker") * 100, .groups = "drop") %>%
  complete(sex, fill = list(percent_smoker = 0))  # ensure both sexes appear

# Side-by-side bar plot
ggplot(smoking_percent, aes(x = sex, y = percent_smoker, fill = sex)) +
  geom_col(width = 0.5) +
  geom_text(aes(label = paste0(round(percent_smoker, 1), "%")), 
            vjust = -0.5, size = 5) +
  coord_cartesian(ylim = c(0, 100)) +
  labs(title = "Percentage of Smokers by Sex",
       x = "Sex",
       y = "Percentage") +
  theme_minimal() +
  theme(legend.position = "none")

```

At first glance, women tend to smoke less than men (40% vs. 72%), but we need to perform a statistical test to confirm if this difference is significant.  
We will calculate the p-value using a Chi-squared test. If:

  - p-value < 0.05, the difference is statistically significant.  
  - p-value > 0.05, the difference could be due to chance.  


```{r message=FALSE, warning=FALSE, paged.print=FALSE}
# Create contingency table
tab <- table(data_snore$sex, data_snore$smoker)
chisq.test(tab)

```

After the Chi-squared test, we know that p-value is < 0.05, we can now conclude that women smoke significantly less than men in our dataset.

  - From a more general perspective:
    - Are there any correlations between variables?

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
numeric_vars <- data_snore %>% select(where(is.numeric))

cor_matrix <- cor(numeric_vars, use = "complete.obs")

corrplot(
  cor_matrix,
  method = "circle",      
  type = "upper",         
  diag = FALSE,           
  tl.col = "black",       
  tl.srt = 45,        
  title = "Correlation Matrix of Numeric Variables",
  mar = c(0,0,2,0)    
)

cor_table <- cor_matrix %>%
  as.data.frame() %>%
  mutate(var1 = rownames(.)) %>%
  pivot_longer(-var1, names_to = "var2", values_to = "correlation") %>%
  filter(var1 < var2) %>%
  mutate(correlation = round(correlation, 2))

cor_table

```
Based on the correlation analysis, there is only one strong relationship among the variables: height and weight are very highly positively correlated (0.93), which means that taller individuals also tend to weigh more. This is expected and consistent with biological patterns.

For the other variables, the correlations are either very close to zero or weak. Age shows virtually no correlation with weight (0.00) or height (0.02), and only a very weak negative correlation with alcohol consumption (-0.16). Similarly, alcohol consumption has only weak positive correlations with weight (0.09) and height (0.11).

Overall, the conclusion is that height and weight are strongly related, while age and alcohol consumption do not show meaningful correlations with the other variables in this dataset.